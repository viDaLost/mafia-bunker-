<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Бункер</title>
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root{
      --overlay-bg: rgba(0,0,0,.85);
      --card-bg: rgba(30,30,30,.92);
      --panel-bg: rgba(204,204,204,.92);
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: 'Special Elite', monospace;
      background: #000 url('images/bunker-background.jpg') center/cover no-repeat;
      color: white;
      text-align: center;
      padding: 40px 16px;
      font-size: 18px;
      margin: 0;
      opacity: 0;
      visibility: hidden;
      overflow-x: hidden;
      background-attachment: scroll; /* перф. фикс */
    }
    body.loaded { opacity: 1; visibility: visible; transition: opacity .5s ease-in-out; }
    body.no-scroll{ overflow:hidden; }
    body::before{
      content:'';
      position:fixed; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));
      pointer-events:none;
      z-index:-1;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }

    header.topbar{
      position:sticky; top:0; left:0; right:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 0 16px; margin:-24px 0 8px;
      background:linear-gradient(to bottom, rgba(0,0,0,.6), transparent);
      backdrop-filter: blur(2px);
    }
    .btn-icon{
      border:1px solid rgba(255,255,255,.7);
      background:transparent; color:#fff; border-radius:10px;
      padding:8px 12px; font-weight:700; cursor:pointer; font-size:18px;
    }
    .btn{
      display:block; margin:14px auto; background:transparent;
      border:1px solid white; color:white; font-size:20px; font-weight:700;
      cursor:pointer; padding:10px 18px; border-radius:10px;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    img.icon { width:24px; height:24px; vertical-align:middle; margin-right:8px; }

    #preloader {
      position: fixed; inset: 0; background-color: #000; color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; z-index: 9999;
    }
    #preloader.fadeOut { animation: fadeOut .4s ease forwards; }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    input[type="number"], select, .opt-inline input[type="radio"]{
      font-size: 18px;
    }
    input[type="number"], select {
      padding: 10px 16px; border-radius: 14px; border: none; outline: none;
      margin: 8px auto; display:block; width:100%; max-width: 360px;
      background-color: rgba(34,34,34,.9); color:white; text-align:center;
    }
    .opt-inline{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .opt-inline label{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px dashed rgba(255,255,255,.4); border-radius:10px; }

    .card {
      background: var(--card-bg); border: 1px solid #444; padding: 20px;
      border-radius: 12px; margin-top: 20px; text-align: left;
      max-width: 520px; margin-left: auto; margin-right: auto; font-size: 16px;
    }
    .disaster-info, .bunker-info, .synergy-info, .resources-info{
      font-size: 17px; line-height: 1.7; text-align: left;
      max-width: 520px; margin: 0 auto 16px; background-color: var(--panel-bg);
      color: black; padding: 14px 16px; border-radius: 12px;
    }
    .badge{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:14px; font-weight:700; color:#fff;
    }
    .badge.ok{ background:var(--ok) } .badge.warn{ background:var(--warn) } .badge.bad{ background:var(--bad) }

    .card-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 18px; margin-top: 24px; max-width: 90%; margin-left: auto; margin-right: auto;
    }
    .flip-card { width: 100%; height: 140px; perspective: 1000px; cursor: pointer; }
    .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform .6s; transform-style: preserve-3d; }
    .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
      position: absolute; inset:0; -webkit-backface-visibility: hidden; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center; border-radius: 12px;
    }
    .flip-card-front { background-color: rgba(20,20,20,.9); color: white; font-size: 22px; font-weight: bold; padding:8px; text-align:center; }
    .flip-card-back { transform: rotateY(180deg); background-color: rgba(30,30,30,.95); }

    .footer-buttons { margin-top: 32px; padding-bottom: 32px; display:flex; justify-content:center; flex-wrap:wrap; gap:12px; }
    .footer-buttons .btn { width: 45%; min-width:180px; }

    .overlay {
      position: fixed; inset:0; background: var(--overlay-bg);
      display:none; align-items: center; justify-content: center; z-index: 1000;
    }
    .overlay.active { display: flex; }
    .overlay-content {
      background: #1e1e1e; padding: 20px; border-radius: 12px; max-width: 560px; width: min(92%, 560px);
      text-align: left; animation: expandFromCard .25s ease forwards; transform: scale(.9); opacity: 0; color: white;
      outline: none; /* для focus-visible */
    }
    @keyframes expandFromCard { to { transform: scale(1); opacity: 1; } }
    @keyframes collapseToCard { to { transform: scale(.9); opacity: 0; } }

    .rounds-panel{
      max-width: 820px; margin: 18px auto 0; text-align:left;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.2);
      border-radius:12px; padding:16px;
    }
    .rounds-panel h3{ margin:6px 0 8px }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .row > * { flex: 0 0 auto }
    .m0{ margin:0 }
    .mt8{ margin-top:8px }
    .mt12{ margin-top:12px }
    .mt16{ margin-top:16px }
    .mt20{ margin-top:20px }
    .muted{ opacity:.85 }

    a.help-link{ color:#fff; text-decoration:underline; cursor:pointer }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div id="preloader">Загрузка...</div>

  <header class="topbar">
    <div style="font-weight:700">Игра Бункер</div>
    <button id="helpBtn" class="btn-icon" aria-haspopup="dialog" aria-controls="overlayContent" aria-label="Открыть справку">?</button>
  </header>

  <div id="setup" class="fade-in" aria-labelledby="setupTitle">
    <h2 id="setupTitle" class="m0">Настройки партии</h2>
    <p class="muted">Введите количество игроков (2–30) и параметры</p>
    <input type="number" id="playerCount" min="2" max="30" value="5" aria-label="Количество игроков"/>

    <div class="card" aria-label="Настройка цели выживания">
      <h3 class="m0">Кто выживает</h3>
      <div class="opt-inline mt12" role="radiogroup" aria-label="Режим цели">
        <label><input type="radio" name="survMode" value="percent" checked> Процент</label>
        <label><input type="radio" name="survMode" value="absolute"> Абсолютно</label>
      </div>
      <div id="survPercentWrap" class="mt12">
        <select id="survPercent">
          <option value="20">20%</option>
          <option value="30">30%</option>
          <option value="40">40%</option>
        </select>
      </div>
      <div id="survAbsoluteWrap" class="mt12" style="display:none">
        <input type="number" id="survAbsolute" min="1" value="3" aria-label="Число выживших"/>
      </div>

      <div class="row mt16">
        <label for="rounds" class="sr-only">Количество раундов</label>
        <input type="number" id="rounds" min="2" max="10" value="6" aria-label="Количество раундов"/>
        <select id="removalMode" aria-label="Модель исключений">
          <option value="even">Равномерно</option>
          <option value="frontloaded">Жёстко в начале</option>
          <option value="backloaded">Нарастающе</option>
          <option value="draft">Драфт (1-й без исключений)</option>
        </select>
      </div>
    </div>

    <button class="btn" onclick="startBunker()">Начать игру</button>
  </div>

  <div id="disasterInfo" style="display:none">
    <div class="disaster-info" id="disasterText" role="region" aria-live="polite"></div>
    <div class="bunker-info" id="bunkerText" role="region"></div>
    <div class="synergy-info" id="synergyBox" role="region" style="display:none"></div>
    <div class="resources-info" id="resourcesBox" role="region" style="display:none"></div>
    <button class="btn" onclick="showPlayerCard()">Показать карточку игрока</button>
  </div>

  <div id="playerCardContainer" style="display: none;">
    <h2 id="playerNumber">Игрок №1</h2>
    <button class="btn" onclick="showCurrentPlayerCard()">Показать карточку</button>
  </div>

  <div id="characterCard" class="card" style="display:none"></div>

  <div id="allCardsShown" style="display:none">
    <h2 class="m0">Все карточки показаны</h2>
    <div id="playerList" class="card-grid"></div>

    <div class="rounds-panel mt16" id="roundsPanel" style="display:none">
      <h3>Раунды и события</h3>
      <p class="m0 muted" id="roundsSummary"></p>
      <div class="row mt12">
        <button class="btn" id="eventBtn">Случайное событие</button>
        <button class="btn" id="statusBtn">Обновить индикатор ресурсов</button>
      </div>
      <div class="mt12" id="eventsLog" aria-live="polite"></div>
    </div>
  </div>

  <div class="footer-buttons">
    <button class="btn" onclick="goToMenu()">Главное меню</button>
    <button class="btn" onclick="restartGame()">В начало игры</button>
  </div>

  <!-- Универсальный оверлей -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="overlay-content" id="overlayContent" role="dialog" aria-modal="true" aria-labelledby="overlayTitle" tabindex="-1"></div>
  </div>

  <script>
  // ---------- Глобальные переменные ----------
  let characters = [];
  let currentCharacterIndex = 0;
  let activeIndex = null; // индекс карточки в гриде при открытом оверлее
  let lastFocusedEl = null; // ловушка фокуса
  let gameState = {
    seed: null,
    removalPlan: [],
    playersTotal: 0,
    playersToStay: 0,
    rounds: 6,
    removalMode: 'even',
    resources: {ratio: 1, status:'ok', details:''},
    disaster: null,
    setting: null,
    suppliesPicked: [],
    eventsHistory: []
  };

  const usedValues = {
    profession: [], health: [], phobia: [], skill: [],
    inventory: [], quality: [], biography: [], secret: []
  };

  const iconMap = {
    "Профессия": "profession.png",
    "Здоровье": "health.png",
    "Фобия": "phobia.png",
    "Навык": "skill.png",
    "Инвентарь": "inventory.png",
    "Качество": "quality.png",
    "Биография": "biography.png",
    "Секрет": "secret.png"
  };

  // ---------- Утилиты ----------
  function capitalizeFirstLetter(str){ return (str||'').charAt(0).toUpperCase() + (str||'').slice(1); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function getRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function getRandomMultiple(arr, min, max){
    const count = Math.floor(Math.random()*(max-min+1))+min;
    const result=[]; const used=new Set();
    while(result.length<count && used.size<arr.length){
      const item=getRandom(arr); if(!used.has(item)){result.push(item); used.add(item);}
    }
    return result;
  }
  function parseDurationToDays(text){
    if(!text) return 30;
    const t=text.toLowerCase();
    const num = parseInt(t.match(/\d+/)?.[0]||'1',10);
    if(/дн/i.test(t)) return num;
    if(/нед/i.test(t)) return num*7;
    if(/мес/i.test(t)) return num*30;
    if(/год|лет|года/.test(t)) return num*365;
    return 30;
  }

  // Кешируем JSON в localStorage (на сессию)
  async function safeFetch(url){
    try{
      const cached = sessionStorage.getItem('cache:'+url);
      if(cached){ return JSON.parse(cached); }
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      const json = await r.json();
      sessionStorage.setItem('cache:'+url, JSON.stringify(json));
      return json;
    }catch(e){
      alert(`Не удалось загрузить ${url}. Проверь файлы и попробуй снова.`);
      throw e;
    }
  }

  // ---------- Оверлей, ловушка фокуса, управление ----------
  const overlay = document.getElementById('overlay');
  const overlayContent = document.getElementById('overlayContent');

  function getFocusable(container){
    return Array.from(container.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
  }

  function openOverlay(html, {fromIndex=null} = {}){
    activeIndex = fromIndex;
    lastFocusedEl = document.activeElement;
    overlayContent.innerHTML = html;
    overlay.setAttribute('aria-hidden','false');
    overlay.classList.add('active');
    document.body.classList.add('no-scroll');

    // фокус
    overlayContent.style.animation = 'expandFromCard .25s ease forwards';
    const focusables = getFocusable(overlayContent);
    (focusables[0] || overlayContent).focus();

    // trap tab внутри диалога
    overlayContent.onkeydown = (e)=>{
      if(e.key === 'Tab'){
        const f = getFocusable(overlayContent);
        if(!f.length){ e.preventDefault(); return; }
        const first=f[0], last=f[f.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      if(e.key === 'Escape'){ closeOverlay(); }
    };
  }

  function closeOverlay(){
    overlayContent.style.animation = 'collapseToCard .2s ease forwards';
    setTimeout(()=>{
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden','true');
      document.body.classList.remove('no-scroll');
      overlayContent.innerHTML='';
      if(lastFocusedEl) lastFocusedEl.focus();
      // снять flip у карточки в гриде
      if(activeIndex!=null){
        const cards = document.querySelectorAll(".flip-card");
        if(cards[activeIndex]) cards[activeIndex].classList.remove("flipped");
      }
      activeIndex = null;
    }, 180);
  }

  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeOverlay(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('active')) closeOverlay(); });

  // ---------- Помощь / onboarding ----------
  document.getElementById('helpBtn').addEventListener('click', ()=>{
    openOverlay(`
      <h2 id="overlayTitle" style="margin-top:0">Как играть</h2>
      <ol>
        <li><strong>Этапы:</strong> Настройка → Катастрофа и Условия → Презентации карт → Раунды и исключения → Итог выживших.</li>
        <li><strong>Таймеры речи:</strong> рекомендуем 30–90с на презентацию. (Добавим виджет по требованию)</li>
        <li><strong>Исключения:</strong> модели — равномерно, жёстко в начале, нарастающе, драфт (1-й раунд без исключений).</li>
        <li><strong>Секреты/События:</strong> каждый раунд вытягивайте карту события — она меняет ресурсы или раскрывает факты.</li>
        <li><strong>Ресурсы:</strong> индикатор пайков показывает обеспеченность на всю длительность укрытия.</li>
        <li><strong>Управление:</strong> Esc или клик вне — закрывает; фокус не «протекает» за окно.</li>
      </ol>
      <div class="row mt16">
        <button class="btn" onclick="closeOverlay()">Понятно</button>
      </div>
    `);
  });

  // ---------- Жизненный цикл ----------
  window.addEventListener("load", () => {
    const p = document.querySelector("#preloader");
    p.classList.add("fadeOut");
    setTimeout(() => p.remove(), 400);
    document.body.classList.add("loaded");

    // лениво декодируем иконки
    if('requestIdleCallback' in window){
      requestIdleCallback(()=>Object.values(iconMap).forEach(src=>{
        const img = new Image(); img.src = 'icons/'+src; img.decode?.();
      }));
    }
  });

  // ---------- Генерация персонажей ----------
  function assignGender(){
    return Math.random()<0.5 ? 'мужчина' : 'женщина';
  }
  function sanitizeByGender(fieldName, value, gender, options){
    // запрещаем беременность у мужчин
    const isPregnancy = /беремен/i.test(value);
    if(gender==='мужчина' && (fieldName==='health' || fieldName==='biography') && isPregnancy){
      // вытянуть новую опцию без беременности (до 10 попыток)
      for(let i=0;i<10;i++){
        const alt = getRandom(options);
        if(!/беремен/i.test(alt)) return alt;
      }
    }
    return value;
  }

  function generateUniqueCharacter(fields){
    const gender = assignGender();
    function pick(fieldName, arr){
      const available = arr.filter(opt => !usedValues[fieldName].includes(opt));
      let value = available.length ? getRandom(available) : getRandom(arr);
      value = sanitizeByGender(fieldName, value, gender, arr);
      usedValues[fieldName].push(value);
      return value;
    }
    return {
      gender,
      profession: pick("profession", fields.professions),
      health: pick("health", fields.health),
      phobia: pick("phobia", fields.phobias),
      skill: pick("skill", fields.skills),
      inventory: pick("inventory", fields.inventory),
      quality: pick("quality", fields.qualities),
      biography: pick("biography", fields.biography),
      secret: pick("secret", fields.secrets)
    };
  }

  // ---------- Расчёт исключений ----------
  function calculateRemoval(totalRemove, rounds, mode='even'){
    const plan = new Array(rounds).fill(0);
    if(totalRemove<=0) return plan;
    if(mode==='draft'){
      // первый раунд без исключений
      const sub = calculateRemoval(totalRemove, rounds-1, 'even');
      for(let i=1;i<rounds;i++) plan[i]=sub[i-1];
      return plan;
    }
    // веса
    let weights=[];
    if(mode==='even'){ weights = new Array(rounds).fill(1); }
    if(mode==='frontloaded'){ // больше в начале
      const base = rounds+1;
      for(let i=0;i<rounds;i++) weights.push((rounds-i)); // 6,5,4...
    }
    if(mode==='backloaded'){ // больше в конце
      for(let i=0;i<rounds;i++) weights.push(i+1); // 1,2,3...
    }
    const sumW = weights.reduce((a,b)=>a+b,0);
    let allocated = 0;
    for(let i=0;i<rounds;i++){
      const share = Math.round(totalRemove * (weights[i]/sumW));
      plan[i]+=share; allocated+=share;
    }
    // корректировка до точной суммы
    while(allocated>totalRemove){
      const idx = plan.findIndex(x=>x>0);
      plan[idx]--; allocated--;
    }
    while(allocated<totalRemove){
      const idx = plan.indexOf(Math.min(...plan));
      plan[idx]++; allocated++;
    }
    return plan;
  }

  // ---------- Синергии и ресурсы ----------
  function classifyDisaster(disaster){
    const t = (disaster?.type||'').toLowerCase();
    if(/биол|вирус|пандем/i.test(t)) return 'BIO';
    if(/радиац|ядер/i.test(t)) return 'RAD';
    if(/химич/i.test(t)) return 'CHEM';
    if(/зомби|инфек/i.test(t)) return 'BIO';
    if(/землетряс|потоп|цунами|вулкан/i.test(t)) return 'NAT';
    return 'GEN';
  }
  function computeSynergy(disaster, chars){
    const cat = classifyDisaster(disaster);
    let score = 0;
    const helpful = [];
    const harmful = [];
    chars.forEach((c,i)=>{
      const blob = `${c.profession} ${c.health} ${c.phobia} ${c.skill} ${c.inventory} ${c.quality} ${c.biography}`.toLowerCase();
      const pushIf=(cond,arr,label)=>{ if(cond){ arr.push(`Игрок ${i+1}: ${label}`); } };
      if(cat==='BIO'){
        pushIf(/медик|врач|эпидемиолог|санитар|биолог/.test(blob), helpful, 'медицинские навыки');
        pushIf(/респиратор|фильтр|маск|hazmat|противогаз/.test(blob), helpful, 'средства защиты');
        pushIf(/гермофоб|иммунодефицит/.test(blob), harmful, 'уязвимость к инфекции');
      }
      if(cat==='RAD'){
        pushIf(/инженер|дозиметр|свинец|щит|геолог|атом/.test(blob), helpful, 'радиационная защита/знания');
        pushIf(/лучев|ослаблен иммунитет/.test(blob), harmful, 'уязвимость к радиации');
      }
      if(cat==='CHEM'){
        pushIf(/химик|инженер|фильтр|сорбент|neutraliz/i.test(blob), helpful, 'химзащита');
        pushIf(/астма|аллергия/.test(blob), harmful, 'дыхательные риски');
      }
      if(cat==='NAT'){
        pushIf(/строит|архитект|инженер|лесоруб|спасател/.test(blob), helpful, 'поиск/укрепление/ремонт');
        pushIf(/клаустрофоб|паник/.test(blob), harmful, 'стрессовые реакции');
      }
    });
    score += helpful.length - harmful.length;
    return {category: cat, score, helpful, harmful};
  }

  function estimateSupplies(suppliesList, players, durationDays){
    // эвристика по ключевым словам
    let rationDays = 0;
    const txt = suppliesList.join(' | ').toLowerCase();
    const add = (n)=>{ rationDays += n; };

    suppliesList.forEach(s=>{
      const t = s.toLowerCase();
      if(/консервы|сухпай|круп|рис|макарон|тушёнка/.test(t)) add(20);
      if(/вода|канистр|бутыл/.test(t)) add(10);
      if(/генератор|топливо|дрова|печ|буржуйк/.test(t)) add(5);
      if(/аптеч|медицин/.test(t)) add(3);
      if(/фильтр|противогаз|респиратор/.test(t)) add(3);
      if(/инструмент|набор|ремонт/.test(t)) add(2);
      if(/семена|теплица|охота|удочка/.test(t)) add(8);
    });

    // нормируем на людей и длительность
    const need = players * durationDays; // условные "ration-days"
    const ratio = need>0 ? rationDays/need : 1;
    let status = 'ok'; if(ratio<0.7) status='warn'; if(ratio<0.4) status='bad';
    const details = `Пайки: ${Math.round(rationDays)} / Потребность: ${need} (на ${players} чел × ${durationDays} дн)`;
    return {ratio, status, details};
  }

  // ---------- События ----------
  const eventsDeck = [
    {title:'Авария генератора', effect:(st)=>{ st.resources.ratio-=0.05; return 'Генератор дал сбой — эффективность снижается. -5% ресурсов.'; }},
    {title:'Утечка воды', effect:(st)=>{ st.resources.ratio-=0.1; return 'Повреждение бака с водой. -10% ресурсов.'; }},
    {title:'Встреча выживших', effect:(st)=>{ st.resources.ratio+=0.08; return 'Группа выживших обменяла припасы. +8% ресурсов.'; }},
    {title:'Рейд на поверхность', effect:(st)=>{ const ok=Math.random()<0.5; st.resources.ratio += ok?0.07:-0.07; return ok?'Удачный рейд! +7%':'Неудачный рейд… -7%'; }},
    {title:'Раскол в группе', effect:(st)=>{ return 'Конфликт — в следующем голосовании учтите напряжённость.'; }},
    {title:'Сбой фильтров', effect:(st)=>{ st.resources.ratio-=0.06; return 'Фильтры воздуха засорились. -6% ресурсов.'; }},
    {title:'Секрет раскрыт', effect:(st)=>{ revealRandomSecret(); return 'Случайная тайна одного игрока вскрыта.'; }},
    {title:'Инвентарь найден', effect:(st)=>{ revealRandomInventory(); return 'Обнаружен скрытый предмет у одного игрока.'; }},
  ];

  function revealRandomSecret(){
    if(!characters.length) return;
    const i = Math.floor(Math.random()*characters.length);
    const char = characters[i];
    openOverlay(`
      <h3 id="overlayTitle">Секрет игрока №${i+1}</h3>
      <p><strong>Пол:</strong> ${capitalizeFirstLetter(char.gender)}</p>
      <p><strong>Секрет:</strong> ${capitalizeFirstLetter(char.secret)}</p>
      <div class="row mt12"><button class="btn" onclick="closeOverlay()">Закрыть</button></div>
    `);
  }
  function revealRandomInventory(){
    if(!characters.length) return;
    const i = Math.floor(Math.random()*characters.length);
    const char = characters[i];
    openOverlay(`
      <h3 id="overlayTitle">Инвентарь игрока №${i+1}</h3>
      <p><strong>Пол:</strong> ${capitalizeFirstLetter(char.gender)}</p>
      <p><strong>Инвентарь:</strong> ${capitalizeFirstLetter(char.inventory)}</p>
      <div class="row mt12"><button class="btn" onclick="closeOverlay()">Закрыть</button></div>
    `);
  }

  function updateResourcesBox(){
    // нормируем и статус
    gameState.resources.ratio = clamp(gameState.resources.ratio, 0, 2);
    let status='ok'; if(gameState.resources.ratio<0.7) status='warn'; if(gameState.resources.ratio<0.4) status='bad';
    gameState.resources.status = status;
    const pct = Math.round(gameState.resources.ratio*100);
    const cls = status==='ok'?'ok':(status==='warn'?'warn':'bad');
    const box = document.getElementById('resourcesBox');
    box.style.display = 'block';
    box.innerHTML = `
      <strong>Индикатор ресурсов:</strong>
      <div class="mt8">Обеспеченность: <span class="badge ${cls}">${pct}%</span></div>
      <div class="mt8">${gameState.resources.details}</div>
      <div class="muted mt8">На голосование влияет риск дефицита: <em>${status==='ok'?'низкий':'высокий'}</em>.</div>
    `;
  }

  // ---------- UI действия ----------
  function showPlayerCard(){
    document.getElementById("disasterInfo").style.display = "none";
    document.getElementById("playerNumber").innerText = `Игрок №1`;
    document.getElementById("playerCardContainer").style.display = "block";
  }

  function renderCharacterHTML(char, idx){
    let html = `<h3>Карточка игрока ${idx+1}</h3>`;
    html += `<p><strong>Пол:</strong> ${capitalizeFirstLetter(char.gender)}</p><br/>`;
    for (const [label, key] of Object.entries({
      "Профессия": "profession", "Здоровье": "health", "Фобия": "phobia",
      "Навык": "skill", "Инвентарь": "inventory", "Качество": "quality",
      "Биография": "biography", "Секрет": "secret"
    })) {
      const icon = iconMap[label];
      html += `<p><img src="icons/${icon}" class="icon" alt="${label}"><strong>${label}:</strong> ${capitalizeFirstLetter(char[key])}</p><br/>`;
    }
    return html;
  }

  function showCurrentPlayerCard(){
    const chars = characters;
    if (currentCharacterIndex >= chars.length) return;
    const char = chars[currentCharacterIndex];
    let html = renderCharacterHTML(char, currentCharacterIndex);
    html += `<button class="btn" onclick="nextPlayer()">Следующий игрок</button>`;
    const box = document.getElementById("characterCard");
    box.innerHTML = html;
    box.style.display = "block";
    document.getElementById("playerCardContainer").style.display = "none";
  }

  function nextPlayer(){
    currentCharacterIndex++;
    if (currentCharacterIndex < characters.length) {
      document.getElementById("playerNumber").innerText = `Игрок №${currentCharacterIndex + 1}`;
      document.getElementById("playerCardContainer").style.display = "block";
      document.getElementById("characterCard").style.display = "none";
    } else {
      showAllPlayers();
    }
  }

  function showAllPlayers(){
    document.getElementById("characterCard").style.display = "none";
    document.getElementById("playerCardContainer").style.display = "none";
    document.getElementById("allCardsShown").style.display = "block";

    const listDiv = document.getElementById("playerList");
    listDiv.innerHTML = "";
    characters.forEach((char, i) => {
      const card = document.createElement("div");
      card.className = "flip-card";
      card.addEventListener("click", () => {
        card.classList.add("flipped");
        setTimeout(()=>{
          openOverlay(`
            ${renderCharacterHTML(char, i)}
            <div class="row mt12"><button class="btn" onclick="closeOverlay()">Закрыть</button></div>
          `, {fromIndex:i});
        }, 250);
      });
      card.innerHTML = `
        <div class="flip-card-inner">
          <div class="flip-card-front">Игрок ${i + 1}</div>
          <div class="flip-card-back">Открыть</div>
        </div>
      `;
      listDiv.appendChild(card);
    });

    // показать панель раундов
    const rp = document.getElementById('roundsPanel');
    rp.style.display = 'block';
    document.getElementById('roundsSummary').textContent =
      `Раундов: ${gameState.rounds}. Исключения по раундам: ${gameState.removalPlan.join(', ')}. Остаться должны: ${gameState.playersToStay}.`;

    document.getElementById('eventBtn').onclick = ()=>{
      const ev = getRandom(eventsDeck);
      const res = ev.effect(gameState);
      gameState.eventsHistory.push(`${ev.title}: ${res}`);
      document.getElementById('eventsLog').innerHTML =
        `<div class="card"><strong>${ev.title}</strong><div class="mt8">${res}</div></div>` +
        document.getElementById('eventsLog').innerHTML;
      updateResourcesBox();
    };
    document.getElementById('statusBtn').onclick = updateResourcesBox;
  }

  function goToMenu(){ window.location.href = "index.html"; }
  function restartGame(){ location.reload(); }

  // ---------- Старт игры ----------
  async function startBunker(){
    // настройки цели
    const players = clamp(parseInt(document.getElementById("playerCount").value||'0',10), 2, 30);
    const rounds = clamp(parseInt(document.getElementById("rounds").value||'6',10), 2, 10);
    const removalMode = document.getElementById('removalMode').value;

    const mode = document.querySelector('input[name="survMode"]:checked')?.value || 'percent';
    let playersToStay = 0;
    if(mode==='percent'){
      const perc = parseInt(document.getElementById('survPercent').value,10);
      playersToStay = Math.max(1, Math.round(players * (perc/100)));
    }else{
      playersToStay = clamp(parseInt(document.getElementById('survAbsolute').value||'1',10), 1, players-1);
    }

    const [disasters, settings, fields, supplies] = await Promise.all([
      safeFetch("data/disasters.json"),
      safeFetch("data/bunker-settings.json"),
      safeFetch("data/fields.json"),
      safeFetch("data/supplies.json")
    ]);

    // генерация персонажей
    characters = Array.from({length: players}, () => generateUniqueCharacter(fields));
    localStorage.setItem("bunkerCharacters", JSON.stringify(characters));

    // UI переход
    document.getElementById("setup").style.display = "none";

    // случайные условия
    const disaster = getRandom(disasters);
    const setting = getRandom(settings);
    const area = getRandom([
      "Площадь бункера — 50 м², одноэтажный",
      "Площадь бункера — 80 м², одноэтажный",
      "Площадь бункера — 120 м², двухэтажный",
      "Площадь бункера — 160 м², одноэтажный",
      "Площадь бункера — 200 м², двухэтажный"
    ]);
    const randomSupplies = getRandomMultiple(supplies, 2, 4);
    const playersToRemove = players - playersToStay;
    const removalPlan = calculateRemoval(playersToRemove, rounds, removalMode);

    // синергии и ресурсы
    const synergy = computeSynergy(disaster, characters);
    const durationDays = parseDurationToDays(setting.duration);
    const resEst = estimateSupplies(randomSupplies, players, durationDays);

    // сохранить в state
    gameState = {
      seed: Math.random().toString(36).slice(2,10),
      removalPlan, playersTotal: players, playersToStay,
      rounds, removalMode,
      resources: resEst, disaster, setting,
      suppliesPicked: randomSupplies, eventsHistory:[]
    };

    // вывести
    document.getElementById("disasterText").innerHTML =
      `<strong>Катастрофа:</strong> ${disaster.type} — ${disaster.description}`;
    document.getElementById("bunkerText").innerHTML = `
      <strong>Условия бункера:</strong><br/>
      ${area}<br/>
      Продолжительность: ${setting.duration}<br/>
      Припасы: ${randomSupplies.join(', ')}<br/><br/>
      <strong>Раунды:</strong><br/>
      Игроков всего: ${players}<br/>
      Остаться должны: ${playersToStay}<br/>
      Исключено за игру: ${playersToRemove}<br/>
      Исключения по раундам: ${removalPlan.join(', ')}
    `;
    // синергии
    const sBox = document.getElementById('synergyBox');
    sBox.style.display='block';
    sBox.innerHTML = `
      <strong>Синергии (${synergy.category}) — счёт: ${synergy.score>=0?'+':''}${synergy.score}</strong>
      <div class="mt8"><u>Полезно:</u> ${synergy.helpful.length? synergy.helpful.join('; ') : '—'}</div>
      <div class="mt8"><u>Риски:</u> ${synergy.harmful.length? synergy.harmful.join('; ') : '—'}</div>
    `;
    // ресурсы
    updateResourcesBox();

    document.getElementById("disasterInfo").style.display = "block";
  }

  // ---------- Переключатели формы цели ----------
  (function initSurvivorsUI(){
    const modeInputs = document.querySelectorAll('input[name="survMode"]');
    const percentWrap = document.getElementById('survPercentWrap');
    const absoluteWrap = document.getElementById('survAbsoluteWrap');
    modeInputs.forEach(inp=>{
      inp.addEventListener('change', ()=>{
        if(inp.value==='percent'){ percentWrap.style.display='block'; absoluteWrap.style.display='none'; }
        else { percentWrap.style.display='none'; absoluteWrap.style.display='block'; }
      }, {passive:true});
    });
  })();

  </script>
</body>
</html>
